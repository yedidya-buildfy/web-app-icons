<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Icon App</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/generate.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="/env.js"></script>
    <script src="/auth.js" defer></script>
    <style>
      .auth-card { max-width: 420px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
      .auth-card h1 { margin-top: 0; }
      .auth-card .field { margin-bottom: 12px; }
      .auth-card .field label { font-weight:600; display:block; margin-bottom:6px; }
      .auth-card input { width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; }
      .btn { padding:10px 14px; border:none; border-radius:6px; color:#fff; cursor:pointer; transition: background-color 0.2s; }
      .btn.primary { background:#007bff; }
      .btn.primary:hover { background:#0056b3; }
      .btn.primary:disabled { background:#6c757d; cursor: not-allowed; }
      .btn.secondary { background:#6c757d; }
      .error { color: #b00020; margin-top: 10px; }
      .success { color: #0a7f3f; margin-top: 10px; }
    </style>
  </head>
  <body data-auth-optional="true">
    <main class="container">
      <!-- Navigation removed for security -->

      <div class="auth-card">
        <h1>Reset Password</h1>
        <div id="requestForm">
          <p>Enter your email to receive a reset link.</p>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" />
          </div>
          <button id="requestBtn" class="btn primary">Send reset link</button>
        </div>

        <div id="updateForm" style="display:none">
          <p>Enter your new password.</p>
          <div class="field">
            <label for="newPassword">New password</label>
            <input id="newPassword" type="password" placeholder="••••••••" />
          </div>
          <button id="updateBtn" class="btn primary">Update password</button>
        </div>

        <div id="msg" class="success" style="display:none"></div>
        <div id="err" class="error" style="display:none"></div>
        
        <div style="margin-top: 20px; text-align: center;">
          <a href="/login.html" style="color: #007bff; text-decoration: none; font-size: 14px;">← Back to Login</a>
        </div>
      </div>
    </main>

    <script>
      const client = window.supabaseAuthClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const msg = document.getElementById('msg');
      const err = document.getElementById('err');
      
      function showMsg(t){ 
        msg.textContent = t; 
        msg.style.display = 'block'; 
        err.style.display = 'none'; 
      }
      
      function showErr(t){ 
        err.textContent = t; 
        err.style.display = 'block'; 
        msg.style.display = 'none'; 
      }

      // Check if this is a password recovery callback
      (async function init(){
        try {
          // Check for auth state change (password recovery)
          const { data: { session } } = await client.auth.getSession();
          
          // Check URL hash for access token (password recovery flow)
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const type = hashParams.get('type');
          
          if (type === 'recovery' && accessToken) {
            // User clicked password reset link - show password update form
            document.getElementById('requestForm').style.display = 'none';
            document.getElementById('updateForm').style.display = 'block';
            showMsg('Please enter your new password below.');
          } else {
            // Show the request form by default
            document.getElementById('requestForm').style.display = 'block';
            document.getElementById('updateForm').style.display = 'none';
          }
        } catch (error) {
          console.error('Init error:', error);
          showErr('Failed to initialize password reset page.');
        }
      })();

      // Handle password reset request
      document.getElementById('requestBtn').addEventListener('click', async () => {
        const emailInput = document.getElementById('email');
        const requestBtn = document.getElementById('requestBtn');
        const email = emailInput.value.trim();
        
        // Clear previous messages
        msg.style.display = 'none';
        err.style.display = 'none';
        
        // Validate email input
        if (!email) {
          showErr('Please enter your email address.');
          emailInput.focus();
          return;
        }
        
        // Basic email format validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showErr('Please enter a valid email address.');
          emailInput.focus();
          return;
        }
        
        // Show loading state
        requestBtn.disabled = true;
        requestBtn.textContent = 'Sending...';
        
        try {
          const { data, error } = await client.auth.resetPasswordForEmail(email, { 
            redirectTo: window.location.origin + '/reset-password.html'
          });
          
          if (error) {
            console.error('Password reset error:', error);
            // Handle specific error types
            if (error.message.includes('rate limit')) {
              showErr('Too many requests. Please wait before trying again.');
            } else if (error.message.includes('invalid email')) {
              showErr('Please enter a valid email address.');
            } else {
              showErr(`Failed to send reset email: ${error.message}`);
            }
          } else {
            console.log('Password reset email sent successfully:', data);
            showMsg('Password reset link sent! Check your email inbox and spam folder. The link will expire in 1 hour.');
            emailInput.value = ''; // Clear the input
          }
        } catch (e) {
          console.error('Password reset exception:', e);
          showErr('Network error. Please check your connection and try again.');
        } finally {
          // Reset button state
          requestBtn.disabled = false;
          requestBtn.textContent = 'Send reset link';
        }
      });

      // Handle password update
      document.getElementById('updateBtn').addEventListener('click', async () => {
        const passwordInput = document.getElementById('newPassword');
        const updateBtn = document.getElementById('updateBtn');
        const newPassword = passwordInput.value;
        
        // Clear previous messages
        msg.style.display = 'none';
        err.style.display = 'none';
        
        // Validate password
        if (!newPassword) {
          showErr('Please enter a new password.');
          passwordInput.focus();
          return;
        }
        
        if (newPassword.length < 8) {
          showErr('Password must be at least 8 characters long.');
          passwordInput.focus();
          return;
        }
        
        // Show loading state
        updateBtn.disabled = true;
        updateBtn.textContent = 'Updating...';
        
        try {
          const { data, error } = await client.auth.updateUser({ 
            password: newPassword 
          });
          
          if (error) {
            console.error('Password update error:', error);
            if (error.message.includes('session')) {
              showErr('Session expired. Please request a new password reset link.');
            } else {
              showErr(`Failed to update password: ${error.message}`);
            }
          } else {
            console.log('Password updated successfully:', data);
            showMsg('Password updated successfully! Redirecting to login page...');
            passwordInput.value = ''; // Clear the input
            
            // Sign out to clear session and redirect to login
            await client.auth.signOut();
            
            setTimeout(() => {
              window.location.href = '/login.html';
            }, 2000);
          }
        } catch (e) {
          console.error('Password update exception:', e);
          showErr('Network error. Please try again.');
        } finally {
          // Reset button state
          updateBtn.disabled = false;
          updateBtn.textContent = 'Update password';
        }
      });

      // Add Enter key support
      document.getElementById('email').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('requestBtn').click();
        }
      });

      document.getElementById('newPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('updateBtn').click();
        }
      });
    </script>
  </body>
</html>
