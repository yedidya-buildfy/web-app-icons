<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Icon App</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/generate.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="/env.js"></script>
    <script src="/auth.js" defer></script>
    <style>
      .auth-card { max-width: 420px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
      .auth-card h1 { margin-top: 0; }
      .auth-card .field { margin-bottom: 12px; }
      .auth-card .field label { font-weight:600; display:block; margin-bottom:6px; }
      .auth-card input { width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; }
      .btn { padding:10px 14px; border:none; border-radius:6px; color:#fff; cursor:pointer; }
      .btn.primary { background:#007bff; }
      .btn.secondary { background:#6c757d; }
      .error { color: #b00020; margin-top: 10px; }
      .success { color: #0a7f3f; margin-top: 10px; }
    </style>
  </head>
  <body>
    <main class="container">
      <nav class="app-nav">
        <a href="/" class="nav-link">Icon Search</a>
        <a href="/generate.html" class="nav-link">Image Generator</a>
        <span id="authNav"></span>
      </nav>

      <div class="auth-card">
        <h1>Reset Password</h1>
        <div id="requestForm">
          <p>Enter your email to receive a reset link.</p>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" />
          </div>
          <button id="requestBtn" class="btn primary">Send reset link</button>
        </div>

        <div id="updateForm" style="display:none">
          <p>Enter your new password.</p>
          <div class="field">
            <label for="newPassword">New password</label>
            <input id="newPassword" type="password" placeholder="••••••••" />
          </div>
          <button id="updateBtn" class="btn primary">Update password</button>
        </div>

        <div id="msg" class="success" style="display:none"></div>
        <div id="err" class="error" style="display:none"></div>
      </div>
    </main>

    <script>
      const client = window.supabaseAuthClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const msg = document.getElementById('msg');
      const err = document.getElementById('err');
      function showMsg(t){ msg.textContent=t; msg.style.display='block'; err.style.display='none'; }
      function showErr(t){ err.textContent=t; err.style.display='block'; msg.style.display='none'; }

      // Determine mode: request link or update password
      (async function init(){
        const hash = new URLSearchParams(window.location.hash.replace(/^#/, ''));
        const access_token = hash.get('access_token');
        if (access_token) {
          // The session is already set by supabase-js on page load for access_token in hash
          document.getElementById('requestForm').style.display='none';
          document.getElementById('updateForm').style.display='block';
        }
      })();

      document.getElementById('requestBtn').addEventListener('click', async () => {
        try {
          const email = document.getElementById('email').value.trim();
          const { error } = await client.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/reset-password.html' });
          if (error) return showErr(error.message);
          showMsg('Reset link sent. Check your email.');
        } catch (e) { showErr('Could not send reset link'); }
      });

      document.getElementById('updateBtn').addEventListener('click', async () => {
        try {
          const newPassword = document.getElementById('newPassword').value;
          const { error } = await client.auth.updateUser({ password: newPassword });
          if (error) return showErr(error.message);
          showMsg('Password updated. You can now log in.');
        } catch (e) { showErr('Could not update password'); }
      });
    </script>
  </body>
</html>
